name: CodeQL LLM-Annotated Analysis

on:
  push:
    branches: [ "experiment/llm-annotated-leak" ]
  pull_request:
    branches: [ "experiment/llm-annotated-leak" ]
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze with LLM Annotations
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        ref: ${{ github.event.pull_request.head.sha || github.sha }}

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake autoconf libtool pkg-config zlib1g-dev libbz2-dev liblzma-dev

    # Inicializa o CodeQL CLI
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
        # Remova a linha 'config-file: ./codeql-config.yml' daqui
        # Apenas 'languages: cpp'

    - name: Build libsolv
      run: |
        mkdir build
        cd build
        cmake ..
        make -j$(nproc)

    # Executa as queries do CodeQL, incluindo seu modelo personalizado.
    # Agora vamos passar o diretório das queries personalizadas diretamente para 'queries'.
    # O CodeQL Action é geralmente inteligente o suficiente para incluir as queries padrão
    # quando você especifica um idioma no 'init' e depois adiciona caminhos no 'analyze'.
    - name: Perform CodeQL Analysis with LLM Annotations
      uses: github/codeql-action/analyze@v3
      with:
        category: "libsolv-llm-annotated"
        # Adicionando o diretório que contém a sua query .qll.
        # O '.' no início é importante para caminhos relativos.
        queries: ./codeql-custom-models/
        # Se isso ainda der o erro 'Unexpected input(s) queries',
        # significa que há algo muito errado com a versão do CodeQL Action
        # ou com o repositório.